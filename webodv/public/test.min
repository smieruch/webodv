var old_storage_name=userId+"_"+project+"_"+datasetname;var storage_name="12"+"_"+userId+"_"+project+"_"+datasetname;var websocket_login=false;localStorage.removeItem(old_storage_name);var treeview_emodnet_contaminants_connect_go=true;var init_outvar_treeview_done=false;var loading_snippet='<div class="loading_snippet"><h1><i class="fa fa-refresh fa-spin fa-fw"></i> Loading </h1></div>';var switch_get_canvas_get_data=false;var selected_variables_vars_height="300px";var treeview_mode=0;var W_get_data_availability_information={};var page2_visit=false;var webodv_status={};var output_vars_list={};var output_p01_list={};var reset_clicked=false;var scatterplot_yes_button_clicked=false;var use_all_vars=true;var var_x_dropdown="";var primary_var_id=0;var a_variable_has_changed="";webodv_status[storage_name]={};var move_map_scatter=true;var count_move_map_scatter=0;var pager_num=1;var pager_num_previous=1;var websocket=null;var download_image_name="";var modify_view_data={};var k1=default_koordinates[0];var k2=default_koordinates[1];var m1=default_koordinates[2];var m2=default_koordinates[3];var zoom_options={};var pointsize=Number(point_size);var orig_size_img_x="";var orig_size_img_y="";var screen_size_img_x="";var screen_size_img_y="";var img_offset={};var htmlcanvas={};var left_click_data={};var modify_view_data={};var get_dock_metavar_labels={};var get_dock_metavar_labels_list="";var get_dock_datavar_labels={};var get_dock_datavar_labels_list="";var dates=[];dates[0]=default_dates[0];dates[1]=default_dates[1];var W_get_collection_information={};var p01_list={};var p01_num=[];var required_vars_mode=false;var required_vars_text="0 variables selected";var x_var=default_x_visualization-1;var y_var=default_y_visualization-1;depth_var_num=depth_var_num-1;var viz_var_trigger=true;var y_axis_reversed=[];var x_axis_reversed=[];var Xstatus={};var date1=[];var date2=[];var treeview_exists=false;var treeview_vars_id="";var treeview_container_search_div="";var List={id:[],dataid:[],text:[]};var List_full={id:[],dataid:[],text:[]};var List_indeterminate={id:[],dataid:[],text:[]};var emodnet_contaminants_tree={};var OutVarState={};var current_cruise="";var window_height=$(window).height();var enable_pager=true;$(function(){$('[data-toggle="tooltip"]').tooltip()});$(document).on("shown.bs.tooltip",function(e){var that=e.target});$(document).ready(function(){$.ajaxSetup({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}});$(".data_preview").html(scatter_plot_button_snippet);if(typeof role!="undefined"){if(role=="devuser"){$("#variables_dev_mode_li").show()}}$("#output_vars_help_close_button").on("click",function(){var dev_pass=$("#variables_dev_mode").val();$.ajax({type:"POST",url:window.location.protocol+"//"+window.location.hostname+http_port+"/dev/emodnet/variables_dev",data:{dev_pass:dev_pass},dataType:"json",cache:"false",func:"dev_emodnet_variables_dev",error:function(data){},success:function(data){}})});if(typeof datasetname!="undefined"){$("#extractor_reset_all,#extractor_help").show()}else{$("#extractor_reset_all,#extractor_help").hide()}var extractor_help_closure=true;if(project=="EMODnet Chemistry"){$("#extractor_help").on("click",function(e){e.preventDefault();$("#extractor_help_modal").modal("show")})}$(".extractor_eraser").on("click",function(e){e.preventDefault();$("#extractor_eraser_modal").modal("show")});$("#outliers_help").on("click",function(e){$("#hide_outliers_modal").modal("show")});$(".help_output_var").on("click",function(e){$("#output_vars_help_modal").modal("show")});$(".selected_vars_info_help").on("click",function(e){$("#and_or_help_modal").modal("show")});$(".modal").on("shown.bs.modal",function(){$(".page-link").addClass("pager-disabled");enable_pager=false});$(".modal").on("hidden.bs.modal",function(){$(".page-link").removeClass("pager-disabled");enable_pager=true});$("#page2_button_enlarge").on("click",function(){$(this).tooltip("hide");if($(this).hasClass("map_small")){$(this).removeClass("map_small").addClass("map_large");$(".page2_map_left").removeClass("col-4").addClass("col-1");$(".page2_map").removeClass("col-4").addClass("col-10");$(".page2_map_right").removeClass("col-4").addClass("col-1");$(this).html('<i class="fa fa-compress"></i>');$(this).attr("data-original-title","Decrease image size")}else if($(this).hasClass("map_large")){$(this).removeClass("map_large").addClass("map_small");$(".page2_map_left").removeClass("col-1").addClass("col-4");$(".page2_map").removeClass("col-10").addClass("col-4");$(".page2_map_right").removeClass("col-1").addClass("col-4");$(this).html('<i class="fa fa-expand"></i>');$(this).attr("data-original-title","Increase image size")}set_window_height()});$(".axes_ranges_question").on("click",function(e){$("#axes_ranges_modal").modal("show")});$(".axes_variables_question").on("click",function(e){$("#axes_variables_modal").modal("show")});$(".axes_full_range_question").on("click",function(e){$("#axes_full_range_modal").modal("show")});if(contaminants==true&&project=="EMODnet Chemistry"){}$("#extractor_eraser_modal").find("#extractor_eraser_apply_button").on("click",function(){localStorage.removeItem(storage_name);localStorage.removeItem("auth_help_not_show_again");localStorage.removeItem("cookies_help_not_show_again");webodv_status[storage_name]={};x_var=default_x_visualization-1;y_var=default_y_visualization-1;y_axis_reversed=[];x_axis_reversed=[];localStorage.setItem(storage_name,JSON.stringify(webodv_status[storage_name]));if(contaminants==true&&project=="EMODnet Chemistry"){treeview_emodnet_contaminants_connect()}$(".reset").trigger("click");treeview_default();treeview_mandatory();$("#outliers").prop("checked",false)});function check_var_reversed_state(){if(typeof Xstatus["reversed_"+y_var.toString()]!="undefined"){y_axis_reversed[y_var.toString()]=Xstatus["reversed_"+y_var.toString()];if(y_axis_reversed[y_var.toString()]=="T"){$("#reversed_axis_checkbox_y").prop("checked",true)}}else{y_axis_reversed[y_var.toString()]="F"}if(typeof Xstatus["reversed_"+x_var.toString()]!="undefined"){x_axis_reversed[x_var.toString()]=Xstatus["reversed_"+x_var.toString()];if(x_axis_reversed[x_var.toString()]=="T"){$("#reversed_axis_checkbox_x").prop("checked",true)}}else{x_axis_reversed[x_var.toString()]="F"}}treeview_mode_check();if(localStorage.getItem(storage_name)!==null){webodv_status[storage_name]=JSON.parse(localStorage.getItem(storage_name));Xstatus=JSON.parse(localStorage.getItem(storage_name));if(typeof Xstatus.date1!="undefined"){dates[0]=Xstatus.date1}if(typeof Xstatus.date2!="undefined"){dates[1]=Xstatus.date2}if(typeof Xstatus.pointsize!="undefined"){pointsize=Number(Xstatus.pointsize)}if(typeof Xstatus.ReqVarNum!="undefined"){if(Xstatus.ReqVarNum==1){required_vars_text=Xstatus.ReqVarNum+" variable selected"}else{required_vars_text=Xstatus.ReqVarNum+" variables selected"}$("#required_vars_button").text(required_vars_text)}if(typeof Xstatus.viz_x_var!="undefined"){x_var=Number(Xstatus.viz_x_var)}if(typeof Xstatus.viz_y_var!="undefined"){y_var=Number(Xstatus.viz_y_var)}var range_id="range_"+x_var.toString()+"_"+y_var.toString();if(typeof Xstatus[range_id]!="undefined"){webodv_status[storage_name][range_id]=Xstatus[range_id]}else{var range={x_range_from:-1e10,x_range_to:1e10,y_range_from:-1e10,y_range_to:1e10};webodv_status[storage_name][range_id]=range}if(typeof Xstatus.outliers!="undefined"){$("#outliers").prop("checked",Xstatus.outliers)}check_var_reversed_state();if(typeof Xstatus.treeview_mode!="undefined"){if(Xstatus.treeview_mode==0){$("#treeview_mode_or").trigger("click");treeview_mode=0}if(Xstatus.treeview_mode==1){$("#treeview_mode_and").trigger("click");treeview_mode=1}}}var myDefaultWhiteList=$.fn.selectpicker.Constructor.DEFAULTS.whiteList;myDefaultWhiteList.span=["data-toggle","data-placement","title"];$(".selectpicker_wrapper").children(".dropdown").css({"background-color":"#fafafa"});function setpointsize(){var pointsize_option=$("#point_size").children("option");$.each(pointsize_option,function(i,e){if(Number($(this).val())==Number(pointsize)){$("#point_size").selectpicker("val",pointsize.toString())}})}setpointsize();$("#pager_large_1,#pager_small_1").addClass("active");var number_of_pages=4;activate_pager=function(){if(enable_pager==true&&pager_num<number_of_pages+2){$(".data_preview_page").hide();$(".page-item").removeClass("active");if(pager_num<1){pager_num=1}if(pager_num>number_of_pages){pager_num=number_of_pages}$("#pager_large_"+pager_num.toString()+",#pager_small_"+pager_num.toString()).addClass("active");$(".webodvextractor_page").hide();$(".webodvextractor_page_"+pager_num.toString()).show();set_window_height();if(pager_num==2){$("#search_output_vars").hide()}if(pager_num==1){$("#search_output").hide()}$(document).trigger("page",pager_num)}};$(".page-link").on("focus",function(e){$(this).blur()});$(".page-link").on("click",function(e){e.preventDefault()});$(".data_preview").on("click",function(){show_image_loading(".img_col");pager_num_previous=pager_num;pager_num=99;$(".webodvextractor_page").hide();$(".page-item").removeClass("active");$(".data_preview_page").show();$(document).trigger("page",pager_num)});$(".data_preview_go_back").on("click",function(){pager_num=pager_num_previous;$("#pager_large_"+pager_num+", #pager_small_"+pager_num).trigger("click")});$(".webodv_pager").on("click",function(){pager_num=Number($(this).attr("id").substring(12,13));activate_pager()});$(".webodv_pager_left").on("click",function(){pager_num--;activate_pager()});$(".webodv_pager_right").on("click",function(){pager_num++;activate_pager()});$(document).keydown(function(event){var disable_pager_now=false;if(enable_pager){if($("#date1").is(":focus")){disable_pager_now=true}if($("#date2").is(":focus")){disable_pager_now=true}if($(".range").is(":focus")){disable_pager_now=true}if($(".bs-searchbox").children("input").is(":focus")){disable_pager_now=true}if($("#search_input_vars").is(":focus")){disable_pager_now=true}if($("#search_input").is(":focus")){disable_pager_now=true}if(disable_pager_now==false){if(event.which==37){event.preventDefault();pager_num--;activate_pager()}if(event.which==39){event.preventDefault();pager_num++;activate_pager()}}}});window.show_image_loading=function(loading_id_or_class){$(loading_id_or_class).prepend(loading_snippet);$(".page-link").addClass("pager-disabled");enable_pager=false};window.hide_image_loading=function(loading_id_or_class){$(".loading_snippet").remove();$(".page-link").removeClass("pager-disabled");enable_pager=true};$(".webodv_pager_left").children("a").addClass("pager-arrow-disabled");$(document).on("page",function(e,pager_num){$(".webodv_pager_left").children("a").removeClass("pager-arrow-disabled");$(".webodv_pager_right").children("a").removeClass("pager-arrow-disabled");if(pager_num!=99){count_move_map_scatter=0;move_map_scatter=true}if(pager_num==99){var num_stations=Number($(".num_stations").text());if(num_stations==0){$(".data_preview_page").hide();$("#zero_stations_modal").modal("show")}if(num_stations>0){send_wsODV_msg("get_data_availability_information")}}if(pager_num==1){$(".webodv_pager_left").children("a").addClass("pager-arrow-disabled");var load_view_options={view:"$FullScreenMap$"};send_wsODV_msg("load_view",load_view_options);var get_canvas_window_options={win_id:-1,extended_rect:false};send_wsODV_msg("get_canvas_window",get_canvas_window_options)}if(pager_num==2){page2_visit=true;var load_view_options={view:"$FullScreenMap$"};send_wsODV_msg("load_view",load_view_options);treeview_mode=$('input[name="treeview_mode"]:checked').val();webodv_status[storage_name]["treeview_mode"]=treeview_mode;localStorage.setItem(storage_name,JSON.stringify(webodv_status[storage_name]));var get_canvas_window_options={win_id:-1,extended_rect:false};send_wsODV_msg("get_canvas_window",get_canvas_window_options);var num_stations=Number($(".num_stations").text());if(num_stations>=0){var view_snippet="<StationSelectionCriteria>"+'<RequiredVars var_ids="'+""+'" use_or_logic="T"/>'+"</StationSelectionCriteria>";var required_vars_option={view_snippet:view_snippet};send_wsODV_msg("modify_view",required_vars_option);send_wsODV_msg("get_data_availability_information")}}if(pager_num!=2){if(contaminants==true&&project=="EMODnet Chemistry"){}else{}}if(pager_num==3){var num_stations=Number($(".num_stations").text());if(num_stations==0){$(".webodvextractor_page_3").hide();$("#zero_stations_modal").modal("show")}var load_view_options={view:"$FullScreenMap$"};send_wsODV_msg("load_view",load_view_options);var get_canvas_window_options={win_id:-1,extended_rect:false};send_wsODV_msg("get_canvas_window",get_canvas_window_options)}if(pager_num==4){$(".webodv_pager_right").children("a").addClass("pager-arrow-disabled")}});function station_info(){}window.onbeforeunload=function(){show_image_loading(".img_col");send_wsODV_msg("logout_request")};$(".download_image").on("click",function(){$.blockUI({message:'<h1><i class="fa fa-refresh fa-spin fa-fw"></i> Loading </h1>'});download_image_name=Math.random().toString(36).substr(2,8)+".png";var download_image_option={win_id:-1,name:download_image_name};send_wsODV_msg("export_graphics",download_image_option)});var select_cruise_dropdown={};$(".selectpicker").on("rendered.bs.select",function(){$(".bs-searchbox").children("input").attr("placeholder","Search");select_cruise_dropdown=$("#select_cruise").siblings("div")});$("#select_cruise").on("changed.bs.select",function(){var cruises=[-999];$("#select_cruise option:selected").each(function(i,e){cruises[i]=$(this).val()});webodv_status[storage_name]["cruises"]=cruises;localStorage.setItem(storage_name,JSON.stringify(webodv_status[storage_name]));if(cruises==""){var view_snippet='<StationSelectionCriteria> <Names cruise="'+"*"+'"/> </StationSelectionCriteria>'}else{var view_snippet='<StationSelectionCriteria> <Names cruise="'+cruises.join(" || ")+'"/> </StationSelectionCriteria>'}var cruise_option={view_snippet:view_snippet};send_wsODV_msg("modify_view",cruise_option);var get_canvas_window_options={win_id:-1,extended_rect:false};send_wsODV_msg("get_canvas_window",get_canvas_window_options)});$("#select_cruise").on("hidden.bs.select",function(){send_wsODV_msg("get_data_availability_information")});$(".zoom_in").on("click",function(){var that_text=$(this).val();if(that_text=="Zoom mode"){$(this).val("Apply");$(".zoom_out").val("Cancel");$(".zoom_full_range,.zoom_global").prop("disabled",true).css("cursor","not-allowed");Xcropper()}if(that_text=="Apply"){$(this).val("Zoom mode");$(".zoom_out").val("Zoom out");zoom_options={coords:[k1,k2,m1,m2],pointsize:pointsize};send_wsODV_msg("map_domain",zoom_options);if(switch_get_canvas_get_data){var get_canvas_window_options={win_id:-1,extended_rect:false};send_wsODV_msg("get_canvas_window",get_canvas_window_options)}else{var get_canvas_window_options={win_id:-1,extended_rect:false};send_wsODV_msg("get_canvas_window",get_canvas_window_options)}$(".zoom_full_range,.zoom_global").prop("disabled",false).css("cursor","pointer");$(document).trigger("cropper_destroy")}});$(".zoom_out").on("click",function(){var that_text=$(this).val();if(that_text=="Cancel"){$(this).val("Zoom out");$(".zoom_in").val("Zoom mode");$(".zoom_full_range,.zoom_global").prop("disabled",false).css("cursor","pointer");$(document).trigger("cropper_destroy")}else{if(k1>180){k1=k1-360}if(k2>180){k2=k2-360}k1=k1-10;k2=k2+10;m1=m1+10;m2=m2-10;if(k1<=-180){k1=-180}if(k2>=180){k2=180}if(m2<=-90){m2=-90}if(m1>=90){m1=90}zoom_options={coords:[k1,k2,m1,m2],pointsize:pointsize};send_wsODV_msg("map_domain",zoom_options);var get_canvas_window_options={win_id:-1,extended_rect:false};send_wsODV_msg("get_canvas_window",get_canvas_window_options)}});$(".zoom_full_range").on("click",function(){k1=-1e10;k2=1e10;m1=-1e10;m2=1e10;if(branch=="geotraces"){k1=default_koordinates[0];k2=default_koordinates[1];m1=default_koordinates[2];m2=default_koordinates[3]}zoom_options={coords:[k1,k2,m1,m2],pointsize:pointsize};send_wsODV_msg("map_domain",zoom_options);var get_canvas_window_options={win_id:-1,extended_rect:false};send_wsODV_msg("get_canvas_window",get_canvas_window_options)});$(".zoom_global").on("click",function(){k1=-180;k2=180;m1=-90;m2=90;zoom_options={coords:[k1,k2,m1,m2],pointsize:pointsize};send_wsODV_msg("map_domain",zoom_options);var get_canvas_window_options={win_id:-1,extended_rect:false};send_wsODV_msg("get_canvas_window",get_canvas_window_options)});$("#date_enable").on("click",function(){$(this).hide();$("#date_ban").show();$(".show_time_range").css("opacity",1).find("input,button").attr("disabled",false).css("cursor","pointer");$(".show_time_range").find("i").show();setdate()});$("#date_ban").on("click",function(){$(this).hide();$("#date_enable").show();$(".show_time_range").css("opacity",.3).find("input,button").attr("disabled",true).css("cursor","not-allowed");$(".show_time_range").find("i").hide();date_options={date1:"01/01/-99999",date2:"12/31/99999"};send_wsODV_msg("set_date",date_options);var get_canvas_window_options={win_id:-1,extended_rect:false};send_wsODV_msg("get_canvas_window",get_canvas_window_options)});$("#date1").datepicker({uiLibrary:"bootstrap4",showOnFocus:false,showRightIcon:true,value:dates[0],minDate:default_dates[0],maxDate:default_dates[1],close:function(e){},change:function(e){var new_date=$(this).datepicker().value();var date_test=check_date(new_date);var date_test_min_max=check_date_min_max(new_date);if(date_test&&date_test_min_max){setdate()}else{set_datepicker_val("1",dates[0])}}});$("#date2").datepicker({uiLibrary:"bootstrap4",showOnFocus:false,showRightIcon:true,value:dates[1],minDate:default_dates[0],maxDate:default_dates[1],close:function(e){},change:function(e){var new_date=$(this).datepicker().value();var date_test=check_date(new_date);var date_test_min_max=check_date_min_max(new_date);if(date_test&&date_test_min_max){setdate()}else{set_datepicker_val("2",dates[1])}}});check_date=function(datestring){return moment(datestring,"MM/DD/YYYY",true).isValid()};check_date_min_max=function(new_date){var d_min=new Date(default_dates[0]);var d_max=new Date(default_dates[1]);var d_new=new Date(new_date);var check_min_max=true;if(d_new.getTime()<d_min.getTime()){check_min_max=false}if(d_new.getTime()>d_max.getTime()){check_min_max=false}return check_min_max};set_datepicker_val=function(num,val){var $Xdatepicker=$("#date"+num).datepicker();$Xdatepicker.value(val)};setdate=function(){date1=$("#date1").datepicker().value();date2=$("#date2").datepicker().value();var date_options={date1:date1,date2:date2};send_wsODV_msg("set_date",date_options);var get_canvas_window_options={win_id:-1,extended_rect:false};send_wsODV_msg("get_canvas_window",get_canvas_window_options)};$("#required_vars_button").on("click",function(){$("#required_vars_modal").modal("show")});$("#required_variables_help").on("click",function(){$("#required_vars_help_modal").modal("show")});$("#date_help").on("click",function(){$("#date_help_modal").modal("show")});$(".station_info_help").on("click",function(){$("#station_info_help_modal").modal("show")});$(".reset").on("click",function(){$("#required_vars_button").text("0 variables selected");reset_clicked=true;$("#select_cruise").selectpicker("selectAll");webodv_status[storage_name]["cruises"]=[];webodv_status[storage_name]["ReqVarNum"]=0;webodv_status[storage_name]["ReqVarList"]="";webodv_status[storage_name]["ReqVarEx"]="";webodv_status[storage_name]["pointsize"]=point_size;pointsize=Number(point_size);localStorage.setItem(storage_name,JSON.stringify(webodv_status[storage_name]));setpointsize();var view_snippet="<StationSelectionCriteria>"+'<RequiredVarExpression expr=""/>'+"</StationSelectionCriteria>";var required_vars_option={view_snippet:view_snippet};send_wsODV_msg("modify_view",required_vars_option);k1=default_koordinates[0];k2=default_koordinates[1];m1=default_koordinates[2];m2=default_koordinates[3];zoom_options={coords:[default_koordinates[0],default_koordinates[1],default_koordinates[2],default_koordinates[3]],pointsize:point_size};send_wsODV_msg("map_domain",zoom_options);date_options={date1:default_dates[0],date2:default_dates[1]};set_datepicker_val("2",default_dates[1]);set_datepicker_val("1",default_dates[0])});$("#point_size").on("changed.bs.select",function(){pointsize=$("#point_size option:selected").text();zoom_options={coords:[k1,k2,m1,m2],pointsize:pointsize};send_wsODV_msg("map_domain",zoom_options);var get_canvas_window_options={win_id:-1,extended_rect:false};send_wsODV_msg("get_canvas_window",get_canvas_window_options)});$(".treeview_logic_help").on("click",function(e){$("#treeview_logic_help_modal").modal("show")});$("#AND_mode_not_show_again").on("click",function(){localStorage.setItem("AND_mode_not_show_again",true)});function treeview_mode_check(){$('input[name="treeview_mode"]').on("click",function(){treeview_mode=$(this).val();if(localStorage.getItem("AND_mode_not_show_again")===null){if(treeview_mode==1&&pager_num==2){$("#treeview_AND_help_modal").modal("show")}}webodv_status[storage_name]["treeview_mode"]=treeview_mode;localStorage.setItem(storage_name,JSON.stringify(webodv_status[storage_name]));$(".treeview_mode_at_selected_variables").text($(this).next("label").text());$(treeview_vars_id).trigger("CheckUncheckDone")})}$("#set_x_var, #set_y_var").on("changed.bs.select",function(){a_variable_has_changed=$(this).attr("id").substring(4,5);var x_var_str=$("#set_x_var option:selected").val();var y_var_str=$("#set_y_var option:selected").val();x_var=Number(x_var_str);y_var=Number(y_var_str);if(y_var==depth_var_num){}else{}webodv_status[storage_name]["viz_x_var"]=x_var;webodv_status[storage_name]["viz_y_var"]=y_var;localStorage.setItem(storage_name,JSON.stringify(webodv_status[storage_name]));if(viz_var_trigger){var view_snippet='<DataWindow window_id="1"> <AxisVariables> <xAxis var_id="'+x_var+'" is_reversed="'+x_axis_reversed[x_var.toString()]+'"/> <yAxis var_id="'+y_var+'" is_reversed="'+y_axis_reversed[y_var.toString()]+'"/> </AxisVariables> </DataWindow>';var range_id="range_"+x_var.toString()+"_"+y_var.toString();var current_range=webodv_status[storage_name][range_id];if(typeof current_range=="undefined"){var x_from=-1e10;var x_to=1e10;var y_from=-1e10;var y_to=1e10}else{var x_from=current_range.x_range_from;var x_to=current_range.x_range_to;var y_from=current_range.y_range_from;var y_to=current_range.y_range_to}view_snippet=view_snippet+'<DataWindow window_id="1"> <Window> <Geometry x_left="'+x_from+'" x_right="'+x_to+'" /> </Window> </DataWindow>'+'<DataWindow window_id="1"> <Window> <Geometry y_bottom="'+y_from+'" y_top="'+y_to+'" /> </Window> </DataWindow>';var set_x_var_option={view_snippet:view_snippet};send_wsODV_msg("modify_view",set_x_var_option);var get_canvas_window_options={win_id:-1,extended_rect:false};send_wsODV_msg("get_canvas_window",get_canvas_window_options)}});$("#reversed_axis_checkbox_y").on("click",function(){var reversed_state=$(this).prop("checked");if(reversed_state){y_axis_reversed[y_var]="T"}else{y_axis_reversed[y_var]="F"}$(document).trigger("click_on_reversed_box")});$("#reversed_axis_checkbox_x").on("click",function(){var reversed_state=$(this).prop("checked");if(reversed_state){x_axis_reversed[x_var.toString()]="T"}else{x_axis_reversed[x_var.toString()]="F"}$(document).trigger("click_on_reversed_box")});$(document).on("click_on_reversed_box",function(){show_image_loading(".img_col");var view_snippet='<DataWindow window_id="1"> <AxisVariables> <xAxis var_id="'+x_var+'" is_reversed="'+x_axis_reversed[x_var.toString()]+'"/> <yAxis var_id="'+y_var+'" is_reversed="'+y_axis_reversed[y_var.toString()]+'"/> </AxisVariables> </DataWindow>';var range_option={view_snippet:view_snippet};send_wsODV_msg("modify_view",range_option);var get_canvas_window_options={win_id:-1,extended_rect:false};send_wsODV_msg("get_canvas_window",get_canvas_window_options);webodv_status[storage_name]["reversed_"+y_var.toString()]=y_axis_reversed[y_var.toString()];webodv_status[storage_name]["reversed_"+x_var.toString()]=x_axis_reversed[x_var.toString()];localStorage.setItem(storage_name,JSON.stringify(webodv_status[storage_name]))});$(".range").on("change",function(){var xyrange_str=$(this).val();var this_range_id=$(this).attr("id");var trim_possible=!xyrange_str.trim();var xyrange=Number(xyrange_str);var range_id="range_"+x_var.toString()+"_"+y_var.toString();var current_range=webodv_status[storage_name][range_id];if(Number.isInteger(xyrange*1e3)&&trim_possible==false){current_range[this_range_id]=xyrange;var x_from=current_range.x_range_from;var x_to=current_range.x_range_to;var y_from=current_range.y_range_from;var y_to=current_range.y_range_to;show_image_loading(".img_col");view_snippet='<DataWindow window_id="1"> <Window> <Geometry x_left="'+x_from+'" x_right="'+x_to+'" y_bottom="'+y_from+'" y_top="'+y_to+'" /> </Window> </DataWindow>';var range_option={view_snippet:view_snippet};send_wsODV_msg("modify_view",range_option);var get_canvas_window_options={win_id:-1,extended_rect:false};send_wsODV_msg("get_canvas_window",get_canvas_window_options)}else{$(this).val(current_range[this_range_id])}});$("#outliers").on("click",function(){show_image_loading(".img_col");if($(this).is(":checked")){var set_sample_filter_option={option:"set_sample_filter",win_id:1,type:"no_outliers"};webodv_status[storage_name]["outliers"]=true}else{var set_sample_filter_option={option:"set_sample_filter",win_id:1,type:"all_samples"};webodv_status[storage_name]["outliers"]=false}localStorage.setItem(storage_name,JSON.stringify(webodv_status[storage_name]));send_wsODV_msg("execute_option",set_sample_filter_option);var get_canvas_window_options={win_id:-1,extended_rect:false};send_wsODV_msg("get_canvas_window",get_canvas_window_options)});$("#reset_p3").on("click",function(){var view_snippet='<DataWindow window_id="1"> <Window> <Geometry x_left="-1e10" x_right="1e10" /> </Window> </DataWindow>'+'<DataWindow window_id="1"> <Window> <Geometry y_bottom="-1e10" y_top="1e10" /> </Window> </DataWindow>';var range_option={view_snippet:view_snippet};show_image_loading(".img_col");send_wsODV_msg("modify_view",range_option);var get_canvas_window_options={win_id:-1,extended_rect:false};send_wsODV_msg("get_canvas_window",get_canvas_window_options)});$("#scatterplot_yes_button").on("click",function(){scatterplot_yes_button_clicked=true;$("#scatterplot_modal").modal("hide");get_data_availability_information_continue()});$("#scatterplot_modal").on("hidden.bs.modal",function(){if(scatterplot_yes_button_clicked==false){hide_image_loading(".img_col");$("#pager_large_1, #pager_small_1").trigger("click")}scatterplot_yes_button_clicked=false});function get_data_availability_information_continue(){if(pager_num==99){var load_view_options={view:"$OneScatterWin$"};send_wsODV_msg("load_view",load_view_options);if(move_map_scatter){var view_snippet='<MapWindow> <Window> <Geometry x_length_bb="8.5" x_offset_bb="1.5" y_length_bb="7.5" y_offset_bb="11.5"/ > </Window> </MapWindow>';var option={view_snippet:view_snippet};send_wsODV_msg("modify_view",option);var view_snippet='<DataWindow window_id="1"> <Window> <Geometry x_offset_bb="13" y_offset_bb="2" y_length_bb="17" x_length_bb="14.5"/> </Window> </DataWindow>';var option={view_snippet:view_snippet};send_wsODV_msg("modify_view",option);move_map_scatter=false}}if(treeview_emodnet_contaminants_connect_go){treeview_emodnet_contaminants_connect()}treeview_data_available();set_window_height();var anz="0";var ex=[];var_x_dropdown="";var OutVar_temp=[];var scatter_plot_vars=[];if(typeof webodv_status[storage_name]["OutVar"]!="undefined"){scatter_plot_vars=webodv_status[storage_name]["OutVar"]}var primary_var_id_str=(primary_var_id+1).toString();if(contaminants||eutrophication){scatter_plot_vars.splice(0,0,primary_var_id_str)}if(eutrophication){for(var i in eutro_hidden_vars){if(eutro_hidden_vars[i]!=primary_var_id_str){scatter_plot_vars.splice(0,0,eutro_hidden_vars[i])}}}if(jQuery.isEmptyObject(W_get_collection_information)==false){$.each(scatter_plot_vars,function(i,e){ex=e.split("|");$.each(ex,function(f,g){n=Number(g)-1;ns=n.toString();anz=jsonData.station_set[ns];if(anz!="-"){if(contaminants==true&&project=="EMODnet Chemistry"){var_x_dropdown=var_x_dropdown+'<option  value="'+n+'" data-content=\'<span data-toggle="tooltip" data-placement="auto" title="'+p01_list[p01_num[n+1]].tooltip+'">'+p01_num[n+1]+"</span>'>"+p01_num[n+1]+"</span></option>"}else{var_x_dropdown=var_x_dropdown+'<option value="'+n+'">'+W_get_collection_information.datavar_unames[n]+"</option>"}}})})}$("#set_x_var").children("option").remove();$("#set_x_var").append(var_x_dropdown);$("#set_x_var").selectpicker("refresh");$("#set_y_var").children("option").remove();$("#set_y_var").append(var_x_dropdown);$("#set_y_var").selectpicker("refresh");if(pager_num==99){viz_var_trigger=false;x_var_str=x_var.toString();y_var_str=y_var.toString();$("#set_x_var").selectpicker("val",x_var_str);$("#set_y_var").selectpicker("val",y_var_str);if(y_var==depth_var_num){}else{}n=Math.min(Math.max(1e3,W_get_data_availability_information.sample_counts[1]),1e5);pointsize_scatter=Math.max(.4,1.2-.55*(Math.log10(n)-5));var view_snippet='<DataWindow window_id="1"> <AxisVariables> <xAxis var_id="'+x_var+'" is_reversed="'+y_axis_reversed+'"/> <yAxis var_id="'+y_var+'" is_reversed="'+y_axis_reversed+'"/> </AxisVariables> <Symbol small_size="0.3" color="0" type="0" size="'+pointsize_scatter+'"/> </DataWindow>';var range_id="range_"+x_var.toString()+"_"+y_var.toString();var current_range=webodv_status[storage_name][range_id];if(typeof current_range=="undefined"){var x_from=-1e10;var x_to=1e10;var y_from=-1e10;var y_to=1e10}else{var x_from=current_range.x_range_from;var x_to=current_range.x_range_to;var y_from=current_range.y_range_from;var y_to=current_range.y_range_to}view_snippet=view_snippet+'<DataWindow window_id="1"> <Window> <Geometry x_left="'+x_from+'" x_right="'+x_to+'" /> </Window> </DataWindow>'+'<DataWindow window_id="1"> <Window> <Geometry y_bottom="'+y_from+'" y_top="'+y_to+'" /> </Window> </DataWindow>';var set_x_var_option={view_snippet:view_snippet};send_wsODV_msg("modify_view",set_x_var_option);if($("#outliers").is(":checked")){var set_sample_filter_option={option:"set_sample_filter",win_id:1,type:"no_outliers"}}else{var set_sample_filter_option={option:"set_sample_filter",win_id:1,type:"all_samples"}}send_wsODV_msg("execute_option",set_sample_filter_option);var get_canvas_window_options={win_id:-1,extended_rect:false};send_wsODV_msg("get_canvas_window",get_canvas_window_options)}}if(typeof MozWebSocket=="function"){WebSocket=MozWebSocket}if(websocket&&websocket.readyState==1){websocket.close()}websocket=new WebSocket(wsUri);websocket.onopen=function(evt){console.log("CONNECTED");show_image_loading(".img_col");send_wsODV_msg("login_request")};websocket.onmessage=function(evt){if(typeof evt.data=="string"){jsonData=JSON.parse(evt.data);if(jsonData.reply_id=="notification"&&jsonData.success==true&&jsonData.notification_type=="time_out_event"){$("#inactivity_modal").modal("show");$(".webodvextractor_page_1, .webodvextractor_page_2, .webodvextractor_page_3, .webodvextractor_page_4").hide();$("body").on("click",function(e){if($(e.target).hasClass("exit-pager")){return false}$("#inactivity_modal").modal("show")});function inactivityX(){$(".page-link").removeClass("pager-disabled");enable_pager=true}inactivityX();$(document).on("page",function(){if(pager_num!=4){$("#inactivity_modal").modal("show")}$(".webodvextractor_page_1, .webodvextractor_page_2, .webodvextractor_page_3, .data_preview_page").hide();inactivityX()})}if(jsonData.reply_id=="get_collection_information"&&jsonData.success==true){W_get_collection_information=jsonData;primary_var_id=jsonData.primary_var_id;var cruise_names="";$.each(jsonData.cruise_names,function(i,e){cruise_names=cruise_names+'<option value="'+e+'" selected="selected">'+e+"</option>"});$("#select_cruise").append(cruise_names);$("#select_cruise").selectpicker("refresh");if(typeof Xstatus.cruises!="undefined"){if(Xstatus.cruises.length>0){$("#select_cruise").selectpicker("deselectAll");$("#select_cruise").selectpicker("val",Xstatus.cruises)}}}if(jsonData.reply_id=="login_request"&&jsonData.success==true){websocket_login=true;modify_view_data=jsonData;$(".num_stations_total").text(jsonData.station_count).trigger("change");$(".num_stations").text(jsonData.selected_station_count).trigger("change");send_wsODV_msg("get_collection_information");if(localStorage.getItem(storage_name)!==null){Xstatus=JSON.parse(localStorage.getItem(storage_name));if(typeof Xstatus.coords!="undefined"){k1=Xstatus.coords[0];k2=Xstatus.coords[1];m1=Xstatus.coords[2];m2=Xstatus.coords[3]}if(typeof Xstatus.pointsize!="undefined"){pointsize=Xstatus.pointsize}if(contaminants==true&&project=="EMODnet Chemistry"){var dummy=true}else{if(typeof Xstatus.ReqVarEx!="undefined"){ReqVarEx=Xstatus.ReqVarEx;var view_snippet="<StationSelectionCriteria>"+'<RequiredVarExpression expr="'+ReqVarEx+'"/>'+"</StationSelectionCriteria>";var required_vars_option={view_snippet:view_snippet};send_wsODV_msg("modify_view",required_vars_option)}}}zoom_options={coords:[k1,k2,m1,m2],pointsize:pointsize};send_wsODV_msg("map_domain",zoom_options);date_options={date1:"01/01/-99999",date2:"12/31/99999"};$("#date_ban").trigger("click");if(init_outvar_treeview_done){send_wsODV_msg("get_data_availability_information")}send_wsODV_msg("get_labels")}if(jsonData.reply_id=="load_view"&&jsonData.success==true){if(pager_num==1){modify_view_data.rects[0]=jsonData.rects[0]}}if(jsonData.reply_id=="execute_option"){}if(jsonData.reply_id=="get_dock_metavar_labels"&&jsonData.success==true){get_dock_metavar_labels=jsonData.labels}if(jsonData.reply_id=="get_dock_datavar_labels"&&jsonData.success==true){get_dock_datavar_labels=jsonData.labels}if(jsonData.reply_id=="get_data_availability_information"&&jsonData.success==true){if(pager_num==99){W_get_data_availability_information=jsonData;if(jsonData.sample_counts[1]>12e5){$("#scatterplot_num_samples").text(jsonData.sample_counts[1]);$("#scatterplot_modal").modal("show")}else{get_data_availability_information_continue()}}else{W_get_data_availability_information=jsonData;get_data_availability_information_continue()}}if(jsonData.reply_id=="get_current_station_dock_metadata"&&jsonData.success==true){get_dock_metavar_labels_list='<div class="table-responsive table_wrapper" style="overflow-y:scroll; height:200px;"><table class="table table-sm table-striped table-condensed">';$.each(get_dock_metavar_labels,function(i,e){get_dock_metavar_labels_list=get_dock_metavar_labels_list+'<tr class="station_name"><td>'+e+"</td>"+'<td class="station_name">'+jsonData.values[i]+"</td></tr>";if(e.toString()=="Cruise"){current_cruise=jsonData.values[i]}});get_dock_metavar_labels_list=get_dock_metavar_labels_list+"</table></div>";$(".get_dock_metavar_labels_list").html(get_dock_metavar_labels_list);set_window_height()}if(jsonData.reply_id=="modify_view"&&jsonData.success==true){k1=jsonData.user_rects[0].left;k2=jsonData.user_rects[0].right;m1=jsonData.user_rects[0].top;m2=jsonData.user_rects[0].bottom;modify_view_data=jsonData;if(pager_num==99){count_move_map_scatter++;if(count_move_map_scatter>2){var x_from=modify_view_data.user_rects[1].left;var x_to=modify_view_data.user_rects[1].right;var y_from=modify_view_data.user_rects[1].bottom;var y_to=modify_view_data.user_rects[1].top;$("#x_range_from").val(x_from);$("#x_range_to").val(x_to);$("#y_range_from").val(y_from);$("#y_range_to").val(y_to);if(a_variable_has_changed=="x"){if(typeof(x_axis_reversed[x_var.toString()]!="undefined")){if(x_axis_reversed[x_var.toString()]=="T"){$("#reversed_axis_checkbox_x").prop("checked",true)}else{$("#reversed_axis_checkbox_x").prop("checked",false)}}else{$("#reversed_axis_checkbox_x").prop("checked",false)}a_variable_has_changed="w"}if(a_variable_has_changed=="y"){if(typeof(y_axis_reversed[y_var.toString()]!="undefined")){if(y_axis_reversed[y_var.toString()]=="T"){$("#reversed_axis_checkbox_y").prop("checked",true)}else{$("#reversed_axis_checkbox_y").prop("checked",false)}}else{$("#reversed_axis_checkbox_y").prop("checked",false)}a_variable_has_changed="w"}var m_range={x_range_from:x_from,x_range_to:x_to,y_range_from:y_from,y_range_to:y_to};var m_range_id="range_"+x_var.toString()+"_"+y_var.toString();webodv_status[storage_name][m_range_id]=m_range;localStorage.setItem(storage_name,JSON.stringify(webodv_status[storage_name]))}}$(".num_stations").text(jsonData.selected_station_count).trigger("change");if(!$.isEmptyObject(left_click_data)){var select_current_sample_options={station_id:left_click_data.station_id.toString(),sample_id:left_click_data.sample_id.toString()};send_wsODV_msg("select_current_sample",select_current_sample_options)}}if(jsonData.reply_id=="select_current_sample"){var left_mouse_click_options={odv_mouse_x:jsonData.points.x_coords[0],odv_mouse_y:jsonData.points.y_coords[0]};send_wsODV_msg("left_mouse_click",left_mouse_click_options)}if(jsonData.reply_id=="export_graphics"&&jsonData.success==true){$.unblockUI()}if(jsonData.reply_id=="canvas_left_click_event"&&jsonData.success==true){left_click_data=jsonData;draw_scene(jsonData)}}if(evt.data instanceof Blob){var head;var blob=new Blob([evt.data]);var header=blob.slice(0,256);var body=blob.slice(256);var reader=new FileReader;reader.onload=function(evt){if(head===undefined){head=evt.target.result;head=head.substring(0,head.indexOf("\0"));head=JSON.parse(head);reader.readAsDataURL(body)}else{switch(head.msg_type){case"canvas_image":$(".wsODV_map").attr("src",evt.target.result);break;case"file_contents":$("#download_image_a_page"+pager_num.toString()).attr("href",evt.target.result).attr("download",download_image_name);$("#download_image_button_page"+pager_num.toString()).trigger("click");break;case"custom_image":break}}};reader.readAsText(header)}};websocket.onclose=function(evt){console.log("DISCONNECTED")};websocket.onerror=function(evt){console.log("ERROR");$("#error_modal").modal("show")};send_wsODV_msg=function(xcommand,options){if(xcommand=="login_request"){var websocket_msg={sender_id:sessionId,cmds:[{cmd:"login_request",view:"$FullScreenMap$"}]}}if(xcommand=="logout_request"){var websocket_msg={sender_id:sessionId,cmds:[{cmd:"logout_request",save_view:false}]}}if(xcommand=="get_image"){var websocket_msg={sender_id:sessionId,cmds:[{cmd:"get_image",type:"x_histogram",fmt:"gif",window_id:options.window_id}]}}if(xcommand=="export_graphics"){var websocket_msg={sender_id:sessionId,cmds:[{cmd:"export_graphics",win_id:options.win_id,fmt:"png",dpi:300,transparent_background:true}]}}if(xcommand=="load_view"){var websocket_msg={sender_id:sessionId,cmds:[{cmd:"load_view",view:options.view}]}}if(xcommand=="get_canvas_window"){var websocket_msg={sender_id:sessionId,cmds:[{cmd:"get_canvas_window",win_id:options.win_id,extended_rect:options.extended_rect,fmt:"gif"}]}}if(xcommand=="execute_option"){var websocket_msg={sender_id:sessionId,cmds:[{cmd:"execute_option",option:options.option,win_id:options.win_id,type:options.type}]}}if(xcommand=="modify_view"){var websocket_msg={sender_id:sessionId,cmds:[{cmd:"modify_view",view_snippet:options.view_snippet}]}}if(xcommand=="select_current_sample"){var websocket_msg={sender_id:sessionId,cmds:[{cmd:"select_current_sample",conditions:[{name:"station_id",value:options.station_id},{name:"sample_id",value:options.sample_id}]}]}}if(xcommand=="get_labels"){var websocket_msg={sender_id:sessionId,cmds:[{cmd:"get_dock_metavar_labels"},{cmd:"get_dock_datavar_labels"}]}}if(xcommand=="get_collection_information"){var websocket_msg={sender_id:sessionId,cmds:[{cmd:"get_collection_information"}]}}if(xcommand=="set_date"){if(options.date1!="01/01/-99999"){webodv_status[storage_name]["date1"]=options.date1;webodv_status[storage_name]["date2"]=options.date2;dates[0]=options.date1;dates[1]=options.date2;localStorage.setItem(storage_name,JSON.stringify(webodv_status[storage_name]))}date1=options.date1.split("/");date2=options.date2.split("/");var websocket_msg={sender_id:sessionId,cmds:[{cmd:"modify_view",view_snippet:"<StationSelectionCriteria>"+'<Period first_day="'+date1[1]+'" last_year="'+date2[2]+'" first_month="'+date1[0]+'" last_month="'+date2[0]+'" last_day="'+date2[1]+'" first_year="'+date1[2]+'" first_hour="'+"0"+'" last_hour="'+"24"+'" first_minute="'+"1"+'" last_minute="'+"60"+'"/>'+"</StationSelectionCriteria>"}]}}if(xcommand=="map_domain"){webodv_status[storage_name]["coords"]=options.coords;webodv_status[storage_name]["pointsize"]=options.pointsize;localStorage.setItem(storage_name,JSON.stringify(webodv_status[storage_name]));var websocket_msg={sender_id:sessionId,cmds:[{cmd:"modify_view",view_snippet:'<GeographicMap> <MapDomain lon_min="'+options.coords[0]+'" lon_max="'+options.coords[1]+'" lat_min="'+options.coords[2]+'" lat_max="'+options.coords[3]+'"/> </GeographicMap>'+'<MapWindow  background_color="31"> <Symbol small_size="0.4" color="1" type="0" size="-0.1"/>'}]}}if(xcommand=="pointsize"){webodv_status[storage_name]["pointsize"]=options.pointsize;localStorage.setItem(storage_name,JSON.stringify(webodv_status[storage_name]));var websocket_msg={sender_id:sessionId,cmds:[{cmd:"modify_view",view_snippet:'<MapWindow  background_color="31"> <Symbol small_size="0.4" color="1" type="0" size="'+options.pointsize+'"/>'}]}}if(xcommand=="left_mouse_click"){webodv_status[storage_name]["odv_mouse_x"]=options.odv_mouse_x;webodv_status[storage_name]["odv_mouse_y"]=options.odv_mouse_y;localStorage.setItem(storage_name,JSON.stringify(webodv_status[storage_name]));var websocket_msg={sender_id:sessionId,cmds:[{cmd:"canvas_left_click_event",x:options.odv_mouse_x,y:options.odv_mouse_y},{cmd:"get_current_station_dock_metadata"},{cmd:"get_current_sample_dock_data"}]}}if(xcommand=="get_data_availability_information"){var websocket_msg={sender_id:sessionId,cmds:[{cmd:"get_data_availability_information"}]}}var msg=JSON.stringify(websocket_msg);if(websocket!=null)websocket.send(msg)};$(document).on("cropper_destroy",function(){webodv_canvas_img.cropper.destroy()});var webodv_canvas_img=document.getElementById("wsODV_map");function Xcropper(){new Cropper(webodv_canvas_img,{movable:false,zoomable:false,rotatable:false,scalable:false,autoCropArea:.3,guides:false,viewMode:1,background:false,ready:function(e){var active_window=0;this.cropper.crop();zoom_mode=true;cropperData=this.cropper.getData();cropperData.x=modify_view_data.rects[active_window].left+(modify_view_data.rects[active_window].right-modify_view_data.rects[active_window].left)*.25;cropperData.y=modify_view_data.rects[active_window].top+(modify_view_data.rects[active_window].bottom-modify_view_data.rects[active_window].top)*.25;cropperData.width=(modify_view_data.rects[active_window].right-modify_view_data.rects[active_window].left)*.5;cropperData.height=(modify_view_data.rects[active_window].bottom-modify_view_data.rects[active_window].top)*.5;this.cropper.setData(cropperData);$(document).on("dblclick",function(){}).on("keyup",function(e){if(e.which==13){}if(e.which==27){}});var alpha=(modify_view_data.user_rects[active_window].right-modify_view_data.user_rects[active_window].left)/(modify_view_data.rects[active_window].right-modify_view_data.rects[active_window].left);var beta=(modify_view_data.user_rects[active_window].bottom-modify_view_data.user_rects[active_window].top)/(modify_view_data.rects[active_window].bottom-modify_view_data.rects[active_window].top);var x0=modify_view_data.user_rects[active_window].left-alpha*modify_view_data.rects[active_window].left;var y0=modify_view_data.user_rects[active_window].top-beta*modify_view_data.rects[active_window].top;var x1=cropperData.x;k1=x0+x1*alpha;var x2=cropperData.x+cropperData.width;k2=x0+x2*alpha;var y1=cropperData.y;m1=y0+y1*beta;var y2=cropperData.y+cropperData.height;m2=y0+y2*beta;webodv_canvas_img.addEventListener("crop",function(e){x1=e.detail.x;k1=x0+x1*alpha;x2=e.detail.x+e.detail.width;k2=x0+x2*alpha;y1=e.detail.y;m1=y0+y1*beta;y2=e.detail.y+e.detail.height;m2=y0+y2*beta})}})}$("#wsODV_map").on("load",function(){hide_image_loading(".img_col");if(pager_num==1){if(select_cruise_dropdown.hasClass("show")){}else{if(treeview_emodnet_contaminants_connect_go==false){send_wsODV_msg("get_data_availability_information")}}}if(pager_num==2){}viz_var_trigger=true;if(left_mouse_click_on_map){window_height=$(window).height();window_width=$(window).width();orig_size_img_x=document.getElementById("wsODV_map").naturalWidth;orig_size_img_y=document.getElementById("wsODV_map").naturalHeight;screen_size_img_x=$("#wsODV_map").width();screen_size_img_y=$("#wsODV_map").height();img_offset=$("#wsODV_map").offset();img_offset_parent=$("#wsODV_map").position();canvas=document.createElement("canvas");canvas.style.width=screen_size_img_x;canvas.id="webodv_canvas";canvas.style.height=screen_size_img_y;canvas.width=screen_size_img_x;canvas.height=screen_size_img_y;canvas.style.position="absolute";canvas.style.left=img_offset_parent.left;canvas.style.top=img_offset_parent.top;canvas.style.pointerEvents="none";$(".wsODV_map_container").append(canvas);htmlcanvas=document.getElementById("webodv_canvas");ctx=htmlcanvas.getContext("2d");if(localStorage.getItem(storage_name)!==null){Xstatus=JSON.parse(localStorage.getItem(storage_name));if(typeof Xstatus.odv_mouse_x!="undefined"){var left_mouse_click_options={odv_mouse_x:Xstatus.odv_mouse_x,odv_mouse_y:Xstatus.odv_mouse_y};send_wsODV_msg("left_mouse_click",left_mouse_click_options)}}}});window.set_window_height=function(){var page_pos=$(".webodvextractor_page_"+pager_num).position();var page_height=window.innerHeight;var copyright_div_height=$("#copyright_div").height();var min_height=Number(page_height)-Number(page_pos.top)-Number(copyright_div_height);$(".webodvextractor_page_"+pager_num).css({"min-height":min_height+"px"});var bg_right_height=$(".webodvextractor_page_"+pager_num+" .bg-right").height();var bg_right_pos=$(".webodvextractor_page_"+pager_num+" .bg-right").position();var selected_variables_vars_pos=$(".webodvextractor_page_"+pager_num+" .bg-right"+" .selected_variables_vars").position();if(typeof selected_variables_vars_pos!="undefined"){selected_variables_vars_height=Number(bg_right_height)-Number(selected_variables_vars_pos.top);$(".webodvextractor_page_"+pager_num+" .bg-right"+" .selected_variables_vars").children("h4").children("div").height(selected_variables_vars_height+"px")}};if(left_mouse_click_on_map){$(window).resize(function(){set_window_height();window_height=$(window).height();window_width=$(window).width();screen_size_img_x=$("#wsODV_map").width();screen_size_img_y=$("#wsODV_map").height();img_offset=$("#wsODV_map").offset();canvas.style.width=screen_size_img_x;canvas.style.height=screen_size_img_y;canvas.width=screen_size_img_x;canvas.height=screen_size_img_y;draw_scene(left_click_data)})}function odv2screenScale(){var scale=$("#wsODV_map").width()/orig_size_img_x;return scale}function draw_crosshair(x,y,scale,r){ctx.beginPath();var length=Math.round(30*scale);x=Math.round(x*scale);y=Math.round(y*scale);ctx.strokeStyle="red";ctx.lineWidth=1;ctx.fillStyle="red";ctx.arc(x,y,r*scale,0,2*Math.PI,false);ctx.moveTo(x-length,y);ctx.lineTo(x+length,y);ctx.moveTo(x,y-length);ctx.lineTo(x,y+length);ctx.stroke();ctx.fill();ctx.closePath()}function write_text(x,y,scale,fontsize,Xtext){ctx.beginPath();ctx.font=fontsize+"px sans-serif";ctx.fillStyle="gray";ctx.textAlign="left";ctx.fillText(Xtext,x*scale,y*scale);ctx.closePath()}function draw_circle(x,y,scale,r){r=r*scale;ctx.beginPath();ctx.arc(Math.round(x[0]*scale),Math.round(y[0]*scale),r,0,2*Math.PI,false);ctx.moveTo(Math.round(x[0]*scale),Math.round(y[0]*scale));for(var j=0;j<x.length-1;j++){ctx.moveTo(Math.round(x[j]*scale),Math.round(y[j]*scale));ctx.arc(Math.round(x[j+1]*scale),Math.round(y[j+1]*scale),r,0,2*Math.PI,false)}ctx.fillStyle="red";ctx.fill();ctx.closePath()}function draw_polyline(x,y,scale){ctx.beginPath();ctx.moveTo(Math.round(x[0]*scale),Math.round(y[0]*scale));for(var j=0;j<x.length-1;j++){ctx.moveTo(Math.round(x[j]*scale),Math.round(y[j]*scale));ctx.lineTo(Math.round(x[j+1]*scale),Math.round(y[j+1]*scale))}ctx.lineWidth=1;ctx.strokeStyle="red";ctx.stroke();ctx.closePath()}function draw_border(){ctx.strokeStyle="black";ctx.lineWidth=4;ctx.beginPath();ctx.rect(0,0,screen_size_img_x-1,screen_size_img_y-1);ctx.stroke();ctx.closePath()}function draw_scene(data){if(left_mouse_click_on_map){ctx.clearRect(0,0,htmlcanvas.width,htmlcanvas.height);var scale=odv2screenScale();var Polylines=data.polylines;if(typeof Polylines!="undefined"&&Polylines.length>0){ctx.save();ctx.rect(modify_view_data.rects[0].left*scale,modify_view_data.rects[0].top*scale,(modify_view_data.rects[0].right-modify_view_data.rects[0].left)*scale,(modify_view_data.rects[0].bottom-modify_view_data.rects[0].top)*scale);ctx.rect(data.polylines[0].rect.left*scale,data.polylines[0].rect.top*scale,(data.polylines[0].rect.right-data.polylines[0].rect.left)*scale,(data.polylines[0].rect.bottom-data.polylines[0].rect.top)*scale);ctx.clip();draw_crosshair(data.points.x_coords[0],data.points.y_coords[0],scale,2);ctx.restore()}else{if(typeof data.points!="undefined"){draw_crosshair(data.points.x_coords[0],data.points.y_coords[0],scale,2)}}if(typeof Polylines!="undefined"){for(var i=0;i<Polylines.length;i++){ctx.save();ctx.rect(modify_view_data.rects[i+1].left*scale,modify_view_data.rects[i+1].top*scale,(modify_view_data.rects[i+1].right-modify_view_data.rects[i+1].left)*scale,(modify_view_data.rects[i+1].bottom-modify_view_data.rects[i+1].top)*scale);ctx.clip();draw_crosshair(data.points.x_coords[i+1],data.points.y_coords[i+1],scale,2);draw_circle(data.polylines[i].x_coords,data.polylines[i].y_coords,scale,3);draw_polyline(data.polylines[i].x_coords,data.polylines[i].y_coords,scale,2);ctx.restore()}}}}if(left_mouse_click_on_map){$("#wsODV_map").on("click",function(e){screen_mouse_x=e.pageX-img_offset.left;screen_mouse_y=e.pageY-img_offset.top;odv_mouse_x=Math.round(orig_size_img_x/screen_size_img_x*screen_mouse_x);odv_mouse_y=Math.round(orig_size_img_y/screen_size_img_y*screen_mouse_y);var left_mouse_click_options={odv_mouse_x:odv_mouse_x,odv_mouse_y:odv_mouse_y};send_wsODV_msg("left_mouse_click",left_mouse_click_options)})}});